// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// FAQ Categories
model FaqCategory {
  id          Int      @id @default(autoincrement())
  name        String
  description String
  icon        String
  slug        String   @unique
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  articles FaqArticle[]

  @@map("faq_categories")
}

// FAQ Articles
model FaqArticle {
  id         Int      @id @default(autoincrement())
  categoryId Int
  slug       String   @unique
  views      Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  category     FaqCategory              @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  translations FaqArticleTranslation[]
  ratings      FaqRating[]

  @@index([categoryId])
  @@map("faq_articles")
}

// FAQ Article Translations (for multi-language support)
model FaqArticleTranslation {
  id        Int      @id @default(autoincrement())
  articleId Int
  locale    String   // en, zh-CN, fr, es, ru, pt
  title     String
  content   String   // Markdown content
  keywords  String   // JSON array of keywords
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  article FaqArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, locale])
  @@index([articleId])
  @@index([locale])
  @@map("faq_article_translations")
}

// FAQ Ratings (user feedback)
model FaqRating {
  id        Int      @id @default(autoincrement())
  articleId Int
  userId    String   // User ID from auth system
  isHelpful Boolean  // true = helpful, false = not helpful
  createdAt DateTime @default(now())

  article FaqArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, userId])
  @@index([articleId])
  @@map("faq_ratings")
}

// Zammad User Mapping (maps local user IDs to Zammad user IDs)
model UserZammadMapping {
  id              Int      @id @default(autoincrement())
  userId          String   @unique // Local user ID from auth system
  zammadUserId    Int      // Zammad user ID
  zammadUserEmail String   // Zammad user email (for reference)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([zammadUserId])
  @@map("user_zammad_mappings")
}

// Uploaded Files (metadata for file storage)
model UploadedFile {
  id            String   @id @default(uuid())
  userId        String   // User who uploaded the file
  bucketName    String   // Storage bucket (message-attachments, avatars, ticket-attachments)
  filePath      String   // Relative path to file
  fileName      String   // Original file name
  fileSize      Int      // File size in bytes
  mimeType      String   // MIME type
  referenceType String   // Type: message, user_profile, ticket
  referenceId   String?  // Optional reference ID
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([referenceType, referenceId])
  @@map("uploaded_files")
}

// Ticket Ratings (customer feedback on closed tickets)
model TicketRating {
  id        Int      @id @default(autoincrement())
  ticketId  Int      @unique // Zammad ticket ID
  userId    String   // Customer user ID
  rating    String   // 'positive' or 'negative'
  reason    String?  // Optional feedback reason
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
  @@index([userId])
  @@index([rating])
  @@map("ticket_ratings")
}

// Reply Templates (for staff quick responses)
model ReplyTemplate {
  id          Int      @id @default(autoincrement())
  name        String   // Template name
  content     String   // Template content (supports variables like {customer_name})
  category    String   // Category: first_contact, technical, closing, etc.
  region      String?  // Optional region restriction
  createdById String   // Creator user ID
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([region])
  @@index([isActive])
  @@map("reply_templates")
}

// Ticket Updates (for real-time notifications via webhook + polling)
model TicketUpdate {
  id        String   @id @default(cuid())
  ticketId  Int      // Zammad ticket ID
  event     String   // 'article_created' | 'status_changed' | 'assigned' | 'created'
  data      String?  // JSON: { articleId, newState, assignedTo, senderEmail }
  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([createdAt])
  @@map("ticket_updates")
}

// In-app Notifications (persistent, user-scoped)
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  data      String?
  read      Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())
  expiresAt DateTime?

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([type])
  @@map("notifications")
}

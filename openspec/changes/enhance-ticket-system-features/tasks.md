# 任务清单：增强Ticket系统功能

---

## 阶段1：P1 核心功能增强

### 1.1 工单评价系统 (#23)

**需求**: 需要添加好评和差评，以及好评原因或差评理由
**反馈人**: Jason

- [x] 1.1.1 设计评价数据模型 ✅
  - 创建 `ticket_ratings` 表 (Prisma schema)
  - 字段: ticket_id, rating (positive/negative), reason, created_at

- [x] 1.1.2 创建评价API ✅
  - POST `/api/tickets/[id]/rating` - 提交评价
  - GET `/api/tickets/[id]/rating` - 获取评价

- [x] 1.1.3 实现评价UI组件 ✅
  - `src/components/ticket/ticket-rating.tsx` 已创建
  - 支持选择好评/差评
  - 可选填写评价理由

- [x] 1.1.4 Admin统计面板 ✅
  - Admin Dashboard显示评价统计
  - 显示好评率、满意/不满意数量
  - 显示最近差评并链接到工单详情

---

### 1.2 工单重新激活 (#24)

**需求**: 需要添加客户重新激活工单的开关
**反馈人**: Jason

- [x] 1.2.1 添加重开API ✅
  - PUT `/api/tickets/[id]/reopen` - 重新打开已关闭工单

- [x] 1.2.2 实现重开UI ✅
  - `src/components/ticket/ticket-reopen-button.tsx` 已创建
  - 包含确认对话框

- [x] 1.2.3 权限控制 ✅
  - 客户只能重开自己的工单
  - API已实现权限验证

---

### 1.3 回复模板 (#25)

**需求**: 增加回复模板，技术支持在首次与客户对接时发送模板确认基础信息
**反馈人**: Cody

- [x] 1.3.1 设计模板数据模型 ✅
  - 创建 `reply_templates` 表 (Prisma schema)
  - 字段: id, name, content, category, region, created_by, is_active

- [x] 1.3.2 创建模板管理API ✅
  - CRUD `/api/templates` 和 `/api/templates/[id]`
  - 支持按区域/分类筛选

- [ ] 1.3.3 实现模板管理界面
  - Admin/Staff可创建和管理模板
  - 支持模板分类（首次联系、技术支持、结案等）

- [ ] 1.3.4 实现模板插入功能
  - 在工单回复框添加"插入模板"按钮
  - 选择模板后插入内容
  - 支持模板变量替换（客户名、工单号等）

---

### 1.4 工单排序筛选 (#29)

**需求**: 支持工单按优先级排序/筛选
**反馈人**: Jason

- [x] 1.4.1 添加排序选项 ✅
  - 支持按优先级排序（高→低/低→高）
  - 支持按创建时间、更新时间排序
  - 默认按创建时间倒序

- [x] 1.4.2 添加筛选选项 ✅
  - 支持按优先级筛选（priority=1/2/3）
  - 保持现有状态筛选

- [x] 1.4.3 更新API支持 ✅
  - 添加sort、order、priority参数
  - GET /api/tickets?sort=created_at&order=desc&priority=3

---

### 1.5 工单导出 (#35)

**需求**: Admin账号下需要可以下载全部的TICKET，各个STAFF账号下可以下载各自的TICKET
**反馈人**: SHAMY

- [x] 1.5.1 创建导出API ✅
  - GET `/api/tickets/export` - 导出工单
  - 支持CSV格式
  - Admin导出全部，Staff按区域过滤

- [x] 1.5.2 实现导出UI ✅
  - Admin工单列表已有Export按钮
  - 点击即下载CSV文件

- [x] 1.5.3 导出内容 ✅
  - 工单基本信息
  - 客户信息
  - 分配状态

---

## 阶段2：P2 用户体验优化

### 2.1 工单详情页布局优化 (#36)

**需求**: TICKET状态等基本信息放右边，把中间留给客户和员工的对话，且上面有AI SUMMARY
**反馈人**: SHAMY

- [x] 2.1.1 重构工单详情页布局 ✅
  - 左侧：对话区域（主要内容）
  - 右侧：工单信息面板（状态、优先级、分配等）
  - 顶部：AI摘要区域（placeholder）

- [x] 2.1.2 响应式设计 ✅
  - 移动端：单栏布局
  - 桌面端：3栏grid（对话2列 + 信息1列）

---

### 2.2 消息样式区分 (#37)

**需求**: 员工和客户的对接，用不同底色，一目了然
**反馈人**: SHAMY

- [x] 2.2.1 设计消息样式 ✅
  - 客户消息：左对齐，浅灰背景，圆角气泡
  - 员工消息：右对齐，绿色背景，圆角气泡
  - 系统消息：居中，淡黄背景

- [x] 2.2.2 实现样式组件 ✅
  - 更新ArticleCard为聊天气泡风格
  - 添加发送者角色标识和时间显示

---

### 2.3 工单历史弹窗预览 (#27)

**需求**: 客户管理界面点击查看工单目前会直接跳转，希望用小窗展示历史工单记录
**反馈人**: Archer

- [x] 2.3.1 创建工单历史弹窗组件 ✅
  - `src/components/admin/ticket-history-dialog.tsx`
  - 显示工单列表（标题、状态、日期）
  - 支持点击跳转到工单详情

- [x] 2.3.2 集成到客户管理页面 ✅
  - 用户详情页添加"View Tickets"按钮
  - 弹窗内可点击跳转到详情
  - API新增customer_email过滤支持

---

### 2.4 工单REASSIGN入口 (#39)

**需求**: 工单REASSIGN统一入口
**反馈人**: SHAMY

- [x] 2.4.1 优化分配UI ✅
  - Reassign按钮已移至工单详情页Customer信息下方
  - 支持选择目标Staff

- [ ] 2.4.2 批量重新分配
  - 在Admin工单列表支持批量选择
  - 一键重新分配给指定人员

---

### 2.5 用户头像上传 (#28)

**需求**: 无法改头像，希望1.0能完善此功能
**反馈人**: Dover

- [x] 2.5.1 实现头像上传API
  - POST `/api/users/avatar` - 上传头像
  - 支持裁剪和压缩

- [x] 2.5.2 实现头像上传UI
  - 在Profile设置页添加头像上传
  - 支持预览和裁剪

---

## 阶段3：P3 智能化功能

### 3.1 AI概要功能 (#22)

**需求**: 对于工单、对话增加AI概要的功能，总结内容，解决状态
**反馈人**: Archer

- [ ] 3.1.1 设计AI摘要功能
  - 调用AI生成工单对话摘要
  - 定期更新或手动触发

- [ ] 3.1.2 实现摘要API
  - GET `/api/tickets/[id]/summary` - 获取AI摘要
  - POST `/api/tickets/[id]/summary/refresh` - 刷新摘要

- [ ] 3.1.3 集成到界面
  - 在工单详情页顶部显示摘要
  - 支持展开/折叠

---

### 3.2 AI机型模糊匹配 (#21)

**需求**: 对于机型，需要有个模糊匹配。AT5属于MDT，答案属于MDVR的
**反馈人**: Kevin

- [ ] 3.2.1 优化FAQ知识库
  - 建立产品型号关联表
  - 实现模糊匹配算法

- [ ] 3.2.2 更新AI对话处理
  - 识别产品型号并映射到正确分类
  - 返回相关产品的FAQ

---

### 3.3 SLA时效管理 (#30)

**需求**: 增加时效管理，超过规定时间还没处理完，需要邮件/工单页面弹窗定时提醒技术支持
**反馈人**: Jason

- [ ] 3.3.1 设计SLA规则
  - 创建 `sla_rules` 表
  - 定义响应时间、解决时间阈值

- [ ] 3.3.2 实现SLA监控
  - 后台任务检查超时工单
  - 触发提醒通知

- [ ] 3.3.3 实现提醒功能
  - 页面内提醒（徽章/弹窗）
  - 邮件提醒（可配置）

---

### 3.4 工单状态邮件通知 (#34)

**需求**: 工单处理进度变更时，自动发送邮件提醒客户
**反馈人**: Jason

- [ ] 3.4.1 配置邮件触发条件
  - 状态变更（open→pending→closed）
  - 新回复
  - 分配变更

- [ ] 3.4.2 实现邮件发送
  - 集成邮件服务
  - 使用模板生成邮件内容

- [ ] 3.4.3 用户可配置
  - 允许用户关闭某些通知
  - 设置通知频率

---

## 阶段4：P4 扩展功能

### 4.1 工单提交引导表单 (#26)

**需求**: 可以参考禅道，让客户提交问题时，引导客户填写设备安装环境、设备安装日期，出现问题日期，出现问题数量
**反馈人**: Jason

- [ ] 4.1.1 设计引导表单
  - 设备型号
  - 安装环境/日期
  - 问题日期/数量
  - 问题描述

- [ ] 4.1.2 实现动态表单
  - 根据问题类型显示不同字段
  - 必填项验证

---

### 4.2 未注册用户邮件注册 (#33)

**需求**: 未注册用户发了邮件到SUPPORT，收到邮件，找到TICKET SYSTEM，申请注册，由ADMIN审核是否通过账户申请
**反馈人**: SHAMY

- [ ] 4.2.1 实现注册申请流程
  - 注册申请表单
  - Admin审核界面
  - 审核通过后发送激活邮件

---

### 4.3 用户注册状态识别 (#38)

**需求**: 看到新的工单，需要可以识别该用户是否已注册用户，还是未注册用户，ADMIN可以给未注册用户注册并发送工单系统入口、用户名、密码
**反馈人**: SHAMY

- [ ] 4.3.1 标识未注册用户
  - 在工单列表/详情显示用户注册状态
  - 未注册用户显示特殊标记

- [ ] 4.3.2 Admin快速注册
  - 一键为未注册用户创建账户
  - 自动发送欢迎邮件

---

### 4.4 FAQ批量导入导出 (#40)

**需求**: FAQ可以用EXCEL表格导入，或者其它方式导入，也可以导出
**反馈人**: SHAMY

- [ ] 4.4.1 实现导出功能
  - 导出为Excel格式
  - 包含分类、问题、答案

- [ ] 4.4.2 实现导入功能
  - 上传Excel文件
  - 解析并验证数据
  - 批量创建/更新FAQ

---

### 4.5 邮件模板配置 (#31, #32)

**需求**: 邮件自动恢复签名需要修改，需要修改Ticket系统URL，增加各区域技术的联系方式Whatsapp
**反馈人**: Cody, SHAMY

- [ ] 4.5.1 创建邮件模板管理
  - 支持编辑邮件签名
  - 支持添加区域联系方式
  - 支持自定义Ticket系统URL

---

## 阶段5：暂缓功能

### 5.1 隐藏Business Type (#41)

**需求**: BUSINESS TYPE暂时没有这个功能，先屏蔽，以后有需求再添加
**反馈人**: SHAMY

- [ ] 5.1.1 隐藏Business Type入口
  - 从导航菜单移除
  - 从相关表单移除

---

## 验收标准

### 阶段1完成标准
- [x] 工单评价系统可用 ✅
- [x] 工单重开功能可用 ✅
- [ ] 回复模板可创建和使用（API完成，UI待实现）
- [x] 工单排序筛选功能完整 ✅
- [x] 工单导出功能可用 ✅

### 阶段2完成标准
- [x] 工单详情页布局优化完成 ✅
- [x] 消息样式区分明显 ✅
- [x] 工单历史弹窗可用 ✅
- [x] REASSIGN入口统一 ✅（批量分配待实现）
- [x] 头像上传功能可用 ✅

### 阶段3完成标准
- [ ] AI概要功能可用
- [ ] AI机型匹配优化
- [ ] SLA时效管理可配置
- [ ] 邮件通知可用

### 阶段4完成标准
- [ ] 工单提交表单引导完成
- [ ] 用户注册流程完整
- [ ] FAQ导入导出可用
- [ ] 邮件模板可配置

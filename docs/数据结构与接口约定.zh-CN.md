# 数据结构与接口约定（中文）

> 目的：把“文档里经常被写错/写漏”的关键约定固定下来，并给出对应的真实实现位置，方便核对与排障。

**最后更新**：2026-01-22

---

## 1) 统一 API 响应结构

实现来源：

- 类型：`src/types/api.types.ts`
- 工具函数：`src/lib/utils/api-response.ts`
- 单测：`__tests__/unit/api-response.test.ts`

### ApiResponse<T>

```ts
export interface ApiResponse<T = any> {
  success: boolean
  data?: T
  error?: {
    code: string
    message: string
    details?: any
  }
}
```

### 工具函数（签名要点）

- `successResponse<T>(data: T, status = 200)`
- `errorResponse(code: string, message: string, details?: any, status = 400)`
- 快捷封装：`unauthorizedResponse`/`forbiddenResponse`/`notFoundResponse`/`validationErrorResponse`/`serverErrorResponse`/`serviceUnavailableResponse`

---

## 2) 认证 Session / User 字段

实现来源：

- NextAuth 配置：`src/auth.ts`
- 服务端辅助函数：`src/lib/utils/auth.ts`

### Session.user（关键字段）

- `id`：本系统用户 ID（Zammad 登录时形如 `zammad-<id>`）
- `email`
- `role`：`customer | staff | admin`
- `full_name`
- `region`：可选（例如 `asia-pacific`）
- `zammad_id`：可选（Zammad 用户 ID，数值）
- `group_ids`：可选（Zammad group id 列表，坐席/管理员常用）

---

## 3) Region / Group 映射约定

实现来源：`src/lib/constants/regions.ts`

要点：

- 系统固定 8 个 region（`RegionValue`）
- region 与 Zammad group id 一一对应（例如 `asia-pacific -> 4`）

---

## 4) TicketUpdate（轮询 + SSE）数据结构

实现来源：

- 前端轮询 hook：`src/lib/hooks/use-ticket-updates.ts`
- SSE emitter：`src/lib/sse/emitter.ts`
- SSE stream：`src/app/api/tickets/updates/stream/route.ts`
- Webhook 入站：`src/app/api/webhooks/zammad/route.ts`
- 轮询 API：`src/app/api/tickets/updates/route.ts`

### TicketUpdate.event

当前约定：

- `created`：新工单（根据 ticket/article created_at 时间差推断）
- `article_created`：工单新增回复/消息
- `assigned`：分配（owner 变化）
- `status_changed`：状态变化

### TicketUpdate.data（关键字段）

> `data` 存在于 `TicketUpdate` 表的 JSON 字符串中；对外返回时会解析为对象。

用于权限过滤/展示的常用字段（均为可选）：

- `customerId`：Zammad customer_id（用于 customer 侧过滤）
- `ownerId`：Zammad owner_id（用于 staff 侧过滤）
- `groupId`：Zammad group_id（用于 region 侧过滤）
- `stateId`：Zammad state_id
- `articleId` / `senderEmail` / `subject` / `title`

#### 权限过滤依赖

`GET /api/tickets/updates` 会基于 `TicketUpdate.data` 的 `customerId/ownerId/groupId` 做“最佳努力”过滤：

- customer：必须能匹配 `customerId === session.user.zammad_id`
- staff：排除未分配（`ownerId` 为 `null/0/1`），并要求 `ownerId === session.user.zammad_id` 或 `groupId` 在 staff 可见的 group 中

如果历史数据缺少这些字段，接口会倾向于“不返回”（避免越权泄露）。

### “未分配工单”的约定

- Zammad 使用 `owner_id = 1`（系统用户）表示未分配
- 权限规则（实现以 `src/lib/utils/permission.ts` 为准）：staff 不可见未分配工单（admin 可见）

---

## 5) SSE 事件格式（EventSource）

实现来源：`src/app/api/tickets/updates/stream/route.ts`

服务端会写入两类事件：

- `event: connected`：连接建立后立即发送，payload 形如 `{ userId, timestamp }`
- `event: ticket-update`：推送具体更新，payload 为 `TicketUpdate` JSON

此外还有心跳（注释行）：

- `: heartbeat`

### 定向推送约定

非 `admin` 用户只有在 webhook 计算出目标用户（owner/customer）后才会收到 `ticket-update` 事件；无目标时默认只会推送给 admin（避免广播泄露）。

---

## 6) Zammad Webhook 签名验证

实现来源：`src/app/api/webhooks/zammad/route.ts`

- 环境变量：`ZAMMAD_WEBHOOK_SECRET`（可选）
- Header：`X-Hub-Signature` 或 `X-Zammad-Signature`
- 格式：`sha1=<hex>`（HMAC-SHA1）

---

## 7) X-On-Behalf-Of（代办/冒名）约定

实现来源：`src/lib/zammad/client.ts`

- 客户端在请求时可传 `onBehalfOf?: string`（email/login/ID）
- 传入后会设置 Header：`X-On-Behalf-Of: <value>`
- 前提：Zammad API token 需要具备 `admin.user` 权限

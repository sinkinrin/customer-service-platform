# 变更：修复工单权限和用户体验问题

## 原因

2025年12月30日的测试反馈中发现 **18 个问题**（排除邮箱相关），其中权限/区域问题已在多次测试中反复出现，说明当前权限系统存在根本性缺陷，需要彻底评估和修复。

### 核心问题

1. **权限泄露（P0）**
   - 亚太客户可看到拉美区工单
   - 未分配工单可被其他区域 Staff 查看
   - 中东 Staff 缺少邮件回复权限

2. **功能缺陷（P0）**
   - Admin 删除工单按钮不生效
   - Live 聊天附件无法发送
   - 客户无法主动关闭工单

3. **用户体验问题（P1/P2）**
   - 消息位置显示逻辑错误
   - 时间格式不符合要求
   - 多处翻译缺失
   - 输入框不自适应

## 变更内容

### 阶段 1：权限系统彻底修复（P0）

1. **客户工单隔离**
   - 客户只能看到自己创建的工单（基于 `customer_id` 过滤）
   - 当前用户 ID 以 Zammad 用户 ID（`session.user.zammad_id`）为准
   - 移除任何可能导致跨客户工单泄露的逻辑

2. **Staff 可见性权限强化**
   - 未分配工单仅对 Admin 可见
   - Staff 只能看到分配给自己的工单
   - 无法解析区域的工单视为未分配，仅 Admin 可见
   - 统一权限检查入口，避免分散的权限逻辑

3. **工单分配规则**
   - 新工单默认保持未分配状态（不分配给 Admin）
   - 按客户区域自动设置 group_id

### 阶段 2：功能修复（P0）

4. **工单删除功能**
   - 修复 Admin 删除按钮的前端调用逻辑
   - 确保错误信息正确显示

5. **客户关闭工单**
   - 在客户工单详情页添加"关闭工单"按钮
   - 实现状态更新 API 调用

6. **Live 附件发送**
   - 修复 Live 聊天的文件上传功能

### 阶段 3：用户体验改进（P1/P2）

7. **消息显示逻辑**
   - 根据查看者角色调整消息左右对齐
   - Staff 视角：客户消息在左，Staff 回复在右
   - 客户视角：自己消息在右，Staff 回复在左

8. **时间格式**
   - 工单列表显示完整日期时间格式
   - 格式：`YYYY-MM-DD HH:mm`

9. **翻译完善**
   - 必填项验证提示 i18n
   - 附件上传按钮 i18n
   - 发送者名称本地化

10. **UI 改进**
    - NEW 状态标签改为亮色
    - 工单标题添加 Tooltip
    - 输入框自适应高度
    - 支持粘贴图片（功能增强）

## 影响

### 受影响的规范
- `ticket-permission`（新建）
- `ticket-management`（新建）
- `ticket-ui`（新建）

### 受影响的代码

| 模块 | 文件 | 变更类型 |
|------|------|----------|
| 权限 | `src/app/api/tickets/route.ts` | 重构权限过滤 |
| 权限 | `src/lib/utils/permission.ts` | 新增统一权限工具 |
| 删除 | `src/app/admin/tickets/page.tsx` | 修复删除调用 |
| 关闭 | `src/app/customer/my-tickets/[id]/page.tsx` | 添加关闭按钮 |
| 消息 | `src/components/conversation/message-list.tsx` | 调整对齐逻辑 |
| 时间 | `src/components/ticket/ticket-list.tsx` | 修改时间格式 |
| 翻译 | `messages/*.json` | 添加缺失翻译 |
| UI | `src/components/ticket/*` | 样式和交互改进 |

### 风险

- **BREAKING**：权限逻辑变更可能影响现有用户体验
- 需要全面回归测试确保无遗漏

## 验收标准

1. 客户 A 创建的工单，客户 B 无法查看
2. 未分配工单仅 Admin 可见
3. Staff 只能看到分配给自己的工单
4. 所有 P0 功能正常工作
5. 翻译在所有支持的语言中显示正确

# 任务清单：添加工单通知系统

> [!TIP]
> **重要说明**：经过调研，邮件通知和定时推送应优先使用 **Zammad 内置功能**（Triggers 和 Scheduler），大幅减少开发工作量。

## 1. Zammad 邮件通道配置

### 1.1 邮件服务器配置
- [ ] 1.1.1 在 Zammad Admin → Channels → Email 配置发件邮箱
- [ ] 1.1.2 配置 SMTP 服务器信息
- [ ] 1.1.3 测试邮件发送功能
- [ ] 1.1.4 配置发件人名称和签名
- **预计时间**：0.5天
- **优先级**：P0
- **执行者**：运维/管理员

## 2. 工单创建通知（Zammad Triggers）

### 2.1 新工单通知 Trigger
- [ ] 2.1.1 Zammad Admin → Manage → Triggers → 新建触发器
- [ ] 2.1.2 配置触发条件：Ticket is created
- [ ] 2.1.3 配置动作：Send email to Agent(s) in ticket group
- [ ] 2.1.4 自定义邮件主题和内容模板（使用变量 #{ticket.title} 等）
- **预计时间**：0.5天
- **优先级**：P0
- **执行者**：管理员

### 2.2 工单分配通知 Trigger
- [ ] 2.2.1 新建触发器：工单分配变更时通知
- [ ] 2.2.2 配置触发条件：Owner changed
- [ ] 2.2.3 配置动作：Send email to new owner
- **预计时间**：0.5天
- **优先级**：P1
- **执行者**：管理员

## 3. 未关闭工单定时推送（Zammad Scheduler）

### 3.1 超时工单提醒 Scheduler
- [ ] 3.1.1 Zammad Admin → Manage → Scheduler → 新建调度器
- [ ] 3.1.2 配置执行周期：每小时 或 每天固定时间
- [ ] 3.1.3 配置条件：State = open AND updated_at older than 24 hours
- [ ] 3.1.4 配置动作：Send email reminder to owner
- **预计时间**：0.5天
- **优先级**：P1
- **执行者**：管理员

### 3.2 即将超时警告 Scheduler
- [ ] 3.2.1 新建调度器：工单即将超时警告
- [ ] 3.2.2 条件：State = open AND SLA 即将 escalate
- [ ] 3.2.3 动作：发送警告邮件
- **预计时间**：0.5天
- **优先级**：P2
- **执行者**：管理员

### 3.3 每日汇总报告 Scheduler
- [ ] 3.3.1 新建调度器：每日未关闭工单汇总
- [ ] 3.3.2 执行时间：每天 09:00
- [ ] 3.3.3 条件：State = open
- [ ] 3.3.4 动作：向管理员发送汇总邮件
- **预计时间**：0.5天
- **优先级**：P2
- **执行者**：管理员

## 4. 前端通知展示（可选开发）

### 4.1 站内通知中心（可选）
- [ ] 4.1.1 如需在前端显示通知，创建 notification store
- [ ] 4.1.2 集成 Zammad Webhook 接收事件
- [ ] 4.1.3 在导航栏显示未读通知数
- **预计时间**：2天
- **优先级**：P3
- **说明**：邮件通知已通过 Zammad 实现，站内通知为增强功能

### 4.2 通知偏好设置页面（可选）
- [ ] 4.2.1 在 Staff 设置页添加通知偏好
- [ ] 4.2.2 可选择接收哪些类型的邮件通知
- **预计时间**：1天
- **优先级**：P3

## 5. 验证测试

- [ ] 5.1 创建测试工单，验证 Agent 是否收到邮件
- [ ] 5.2 等待 Scheduler 执行，验证超时提醒
- [ ] 5.3 分配工单给其他 Agent，验证分配通知
- **预计时间**：0.5天

---

## 总结：利用 Zammad 的优势

| 原方案 | 新方案 |
|-------|-------|
| 安装 nodemailer | ❌ 不需要，使用 Zammad 邮件通道 |
| 创建邮件模板 | ❌ 不需要，Zammad Trigger 模板 |
| 开发定时任务调度器 | ❌ 不需要，使用 Zammad Scheduler |
| 配置 Vercel Cron | ❌ 不需要 |
| **总开发时间** | **从 8-10 天减少到 2-3 天（仅配置 + 可选开发）** |

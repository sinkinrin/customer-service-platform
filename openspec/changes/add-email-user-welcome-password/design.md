# 技术设计：邮件用户自动生成欢迎密码

## 背景与约束

- 不能修改 Zammad 核心行为（用户创建由 Zammad 完成）
- 必须通过 Zammad API 设置用户密码、发送欢迎邮件
- 欢迎逻辑不得阻塞 webhook 响应与工单创建主流程

## 目标 / 非目标

### 目标

- 识别首次由邮件触发创建的用户并设置临时密码
- 发送包含登录信息的欢迎邮件（HTML）
- 支持开关控制启用/禁用
- 避免重复处理（幂等）

### 非目标

- 不修改现有 Zammad Trigger 邮件
- 不实现“密码过期/强制改密”机制（首版仅提醒用户自行修改）

## 关键决策

### 1) 去重/幂等机制

使用用户 `note` 字段中的标记 `WelcomeEmailSent:` 作为幂等判断：

- 如果 `note` 包含 `WelcomeEmailSent:`，则跳过密码生成与欢迎邮件发送
- 仅在欢迎邮件发送成功后写入标记（允许邮件失败后在下一次工单重试）

### 2) 密码生成策略

使用 `crypto.randomBytes()` 生成 12 位随机密码，字符集排除易混淆字符（0/O、1/l/I），并包含大小写字母与数字。

### 3) 欢迎邮件发送方式

通过 Zammad Article API 发送外部邮件（记录进入工单历史，复用 Zammad 已配置的邮件通道）：

- `type: 'email'`
- `content_type: 'text/html'`
- `internal: false`

### 4) 执行时机

在 Webhook `created` 事件处理时并行异步触发（`void handleEmailUserWelcome(...)`），不影响 webhook 正常响应。

## 风险与缓解

- 临时密码会出现在工单历史中（Staff/Admin 可见）：欢迎邮件必须包含醒目的安全提示，鼓励首次登录后立即修改密码。
- 并发重复处理：幂等标记可避免重复；如出现极端并发，可通过先写入“处理中”标记进一步加强（后续优化）。


# å˜æ›´ï¼šæ·»åŠ å·¥å•å®æ—¶æ›´æ–°ç³»ç»Ÿ

> **æ–¹æ¡ˆç‰ˆæœ¬**ï¼šv2.0 (Webhook + è½®è¯¢)
> **æ›´æ–°æ—¥æœŸ**ï¼š2025-12-29
> **åŸæ–¹æ¡ˆ**ï¼šSSEï¼ˆå·²æ”¾å¼ƒï¼Œè·¨å¢ƒç½‘ç»œä¸ç¨³å®šï¼‰

## åŸå› 

åŸºäºç”¨æˆ·åé¦ˆï¼ˆ2025-12-26ï¼‰ï¼Œå½“å‰ç³»ç»Ÿç¼ºä¹å®æ—¶æ›´æ–°æœºåˆ¶ï¼Œä¸»è¦é—®é¢˜ï¼š

1. **æ–°æ¶ˆæ¯æ— å®æ—¶æé†’** - å·¥å•æ”¶åˆ°æ–°å›å¤æ—¶ï¼Œstafféœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°
2. **æœªè¯»å·¥å•æ— é«˜äº®** - æ— æ³•å¿«é€Ÿè¯†åˆ«å“ªäº›å·¥å•æœ‰æ–°æ¶ˆæ¯æœªè¯»
3. **çŠ¶æ€å˜åŒ–ä¸åŒæ­¥** - å·¥å•çŠ¶æ€æ›´æ–°åï¼Œéœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°å˜åŒ–

**ç”¨æˆ·åé¦ˆ**ï¼š
- åé¦ˆäººï¼šCody (æŠ€æœ¯æ”¯æŒ)
- æ—¥æœŸï¼š2025-12-26

**æ”¾å¼ƒ SSE çš„åŸå› **ï¼š
- æœåŠ¡å™¨åœ¨ç¾ä¸œï¼Œç”¨æˆ·åœ¨ä¸­å›½æ·±åœ³
- è·¨å¢ƒç½‘ç»œå¯¼è‡´ SSE é•¿è¿æ¥é¢‘ç¹æ–­å¼€
- é˜²ç«å¢™å’Œä»£ç†å¯¹é•¿è¿æ¥ä¸å‹å¥½

## æŠ€æœ¯æ–¹æ¡ˆï¼šWebhook + æ™ºèƒ½è½®è¯¢

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Zammad Server                           â”‚
â”‚  å·¥å•å˜åŒ– â†’ Trigger â†’ Webhook POST                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              /api/webhooks/zammad                            â”‚
â”‚  æ¥æ”¶ Webhook â†’ å†™å…¥ TicketUpdate è¡¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“ (SQLite/PostgreSQL)                       â”‚
â”‚  TicketUpdate: { ticketId, event, timestamp }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†‘ è½®è¯¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‰ç«¯ (Browser)                                   â”‚
â”‚  /api/tickets/updates?since=timestamp                        â”‚
â”‚       â†“                                                      â”‚
â”‚  æœ‰æ›´æ–° â†’ Toast é€šçŸ¥ + åˆ·æ–°åˆ—è¡¨ + æœªè¯»é«˜äº®                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é˜¶æ®µ1ï¼šZammad Webhook é…ç½®ï¼ˆP0ï¼‰

**Zammad Admin é…ç½®**ï¼š
1. åˆ›å»º Webhookï¼š`https://your-domain.com/api/webhooks/zammad`
2. åˆ›å»º Triggerï¼šå·¥å•åˆ›å»º/æ›´æ–°/æ–°æ¶ˆæ¯æ—¶è§¦å‘ Webhook

**äº‹ä»¶ç±»å‹**ï¼š
- `ticket.create` - æ–°å·¥å•åˆ›å»º
- `ticket.update` - å·¥å•çŠ¶æ€/åˆ†é…å˜åŒ–  
- `ticket.article_created` - æ–°æ¶ˆæ¯/å›å¤

### é˜¶æ®µ2ï¼šåç«¯ Webhook å¤„ç†ï¼ˆP0ï¼‰

1. **å¢å¼º Webhook å¤„ç†** (`src/app/api/webhooks/zammad/route.ts`)
   - è§£æ Webhook payload
   - å†™å…¥ TicketUpdate è¡¨
   - è®°å½•äº‹ä»¶ç±»å‹å’Œæ—¶é—´æˆ³

2. **æ•°æ®åº“è¡¨** (`prisma/schema.prisma`)
   ```prisma
   model TicketUpdate {
     id        String   @id @default(cuid())
     ticketId  Int
     event     String   // 'article_created' | 'status_changed' | 'assigned'
     data      String?  // JSON: { articleId, newState, assignedTo }
     createdAt DateTime @default(now())
     
     @@index([ticketId])
     @@index([createdAt])
   }
   ```

3. **æ›´æ–°æŸ¥è¯¢ API** (`src/app/api/tickets/updates/route.ts`)
   - `GET /api/tickets/updates?since=timestamp`
   - è¿”å›æŒ‡å®šæ—¶é—´åçš„æ›´æ–°åˆ—è¡¨
   - æŒ‰ç”¨æˆ·æƒé™è¿‡æ»¤ï¼ˆStaff åªçœ‹è‡ªå·±åŒºåŸŸï¼‰

### é˜¶æ®µ3ï¼šå‰ç«¯æ™ºèƒ½è½®è¯¢ï¼ˆP0ï¼‰

1. **è½®è¯¢ Hook** (`src/lib/hooks/use-ticket-updates.ts`)
   - é»˜è®¤ 30 ç§’è½®è¯¢
   - æœ‰æ›´æ–°æ—¶åˆ‡æ¢åˆ° 5 ç§’å¿«é€Ÿè½®è¯¢
   - é¡µé¢ä¸å¯è§æ—¶æš‚åœè½®è¯¢
   - ç”¨æˆ·æ´»è·ƒæ—¶ 15 ç§’è½®è¯¢

2. **æœªè¯»çŠ¶æ€ç®¡ç†** (`src/lib/stores/unread-store.ts`)
   - Zustand store + localStorage æŒä¹…åŒ–
   - `markAsUnread(ticketId)` / `markAsRead(ticketId)`
   - æœªè¯»è®¡æ•°ç®¡ç†

3. **Toast é€šçŸ¥** 
   - ä½¿ç”¨ç°æœ‰ `sonner` åº“
   - æ–°æ¶ˆæ¯æç¤º + "æŸ¥çœ‹" æŒ‰é’®

### é˜¶æ®µ4ï¼šUI æ›´æ–°ï¼ˆP1ï¼‰

1. **å·¥å•åˆ—è¡¨æœªè¯»é«˜äº®** (`src/components/ticket/ticket-list.tsx`)
   - æœªè¯»å·¥å•å·¦è¾¹è“è‰²è¾¹æ¡†
   - æ ‡é¢˜åŠ ç²—
   - æœªè¯»æ¶ˆæ¯æ•° badge

2. **å¯¼èˆªæ æœªè¯»è®¡æ•°**
   - Tickets é“¾æ¥æ—æ˜¾ç¤ºæœªè¯»æ€»æ•°

## å½±å“

### å—å½±å“çš„ä»£ç 

**æ–°å¢æ–‡ä»¶**ï¼š
- `src/app/api/tickets/updates/route.ts` - æ›´æ–°æŸ¥è¯¢ API
- `src/lib/hooks/use-ticket-updates.ts` - è½®è¯¢ Hook
- `src/lib/stores/unread-store.ts` - æœªè¯»çŠ¶æ€ç®¡ç†

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/app/api/webhooks/zammad/route.ts` - å¢å¼º Webhook å¤„ç†
- `src/components/ticket/ticket-list.tsx` - æ·»åŠ æœªè¯»é«˜äº®
- `prisma/schema.prisma` - æ·»åŠ  TicketUpdate è¡¨

### æ•°æ®åº“å˜æ›´

**æ–°å¢è¡¨**ï¼š
```prisma
model TicketUpdate {
  id        String   @id @default(cuid())
  ticketId  Int
  event     String   // 'article_created' | 'status_changed' | 'assigned'
  data      String?  // JSON é¢å¤–æ•°æ®
  createdAt DateTime @default(now())
  
  @@index([ticketId])
  @@index([createdAt])
}
```

### Zammad é…ç½®è¦æ±‚

éœ€è¦åœ¨ Zammad Admin ä¸­é…ç½®ï¼š
1. **Webhook**: æŒ‡å‘ `/api/webhooks/zammad`
2. **Trigger**: å·¥å•åˆ›å»º/æ›´æ–°æ—¶è§¦å‘ Webhook

### ç ´åæ€§å˜æ›´
- **æ— ç ´åæ€§å˜æ›´**

## ä¼˜å…ˆçº§

**æ•´ä½“ä¼˜å…ˆçº§**ï¼šğŸ”´ P0ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

## é¢„æœŸæ”¶ç›Š

1. **æå‡å“åº”é€Ÿåº¦** - staff æ”¶åˆ°æ–°æ¶ˆæ¯ååŠæ—¶å¾—åˆ°é€šçŸ¥
2. **å‡å°‘é—æ¼** - æœªè¯»é«˜äº®å¸®åŠ© staff å¿«é€Ÿå®šä½å¾…å¤„ç†å·¥å•
3. **ç½‘ç»œç¨³å®š** - çŸ­è¯·æ±‚æ¯”é•¿è¿æ¥åœ¨è·¨å¢ƒç½‘ç»œä¸‹æ›´å¯é 
4. **æé«˜å·¥ä½œæ•ˆç‡** - å‡å°‘ä¸å¿…è¦çš„æ‰‹åŠ¨åˆ·æ–°

## æŠ€æœ¯å¯¹æ¯”

### ä¸ºä»€ä¹ˆé€‰æ‹© Webhook + è½®è¯¢

| æ–¹æ¡ˆ | å®æ—¶æ€§ | è·¨å¢ƒç¨³å®šæ€§ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|-----------|--------|----------|
| **SSE** | â­â­â­ | âŒ æ˜“æ–­è¿ | ä¸­ | åŒåŒºåŸŸéƒ¨ç½² |
| **WebSocket** | â­â­â­ | âŒ æ˜“æ–­è¿ | é«˜ | åŒå‘é€šä¿¡ |
| **çº¯è½®è¯¢** | â­ | âœ… ç¨³å®š | ä½ | ç®€å•åœºæ™¯ |
| **Webhook+è½®è¯¢** | â­â­ | âœ… ç¨³å®š | ä¸­ | âœ… è·¨å¢ƒåœºæ™¯ |

### æ€§èƒ½è€ƒè™‘

**è½®è¯¢é¢‘ç‡**ï¼š
- é»˜è®¤ï¼š30 ç§’
- æœ‰æ›´æ–°åï¼š5 ç§’ï¼ˆæŒç»­ 2 åˆ†é’Ÿï¼‰
- é¡µé¢ä¸å¯è§ï¼šæš‚åœ

**æ•°æ®åº“æ¸…ç†**ï¼š
- å®šæœŸæ¸…ç†è¶…è¿‡ 7 å¤©çš„ TicketUpdate è®°å½•
- é¿å…è¡¨æ— é™å¢é•¿

## é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| Zammad Webhook é…ç½®é”™è¯¯ | é«˜ | æä¾›é…ç½®æ–‡æ¡£ + æ—¥å¿—ç›‘æ§ |
| è½®è¯¢è¯·æ±‚è¿‡å¤š | ä¸­ | æ™ºèƒ½è½®è¯¢ + é¡µé¢å¯è§æ€§æ£€æµ‹ |
| æ•°æ®åº“è¡¨å¢é•¿ | ä¸­ | å®šæœŸæ¸…ç† + ç´¢å¼•ä¼˜åŒ– |
| é€šçŸ¥è¿‡è½½ | ä½ | é˜²æŠ– + åˆå¹¶é€šçŸ¥ |

## å‚è€ƒèµ„æ–™

- [Zammad Webhook æ–‡æ¡£](https://admin-docs.zammad.org/en/latest/manage/webhook.html)
- [Zammad Trigger æ–‡æ¡£](https://admin-docs.zammad.org/en/latest/manage/trigger.html)
- [SWR æ•°æ®åˆ·æ–°](https://swr.vercel.app/docs/revalidation)

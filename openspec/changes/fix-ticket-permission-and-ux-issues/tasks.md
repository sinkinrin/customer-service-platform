# 任务清单

## 1. 权限系统重构（P0）

### 1.1 创建统一权限工具
- [x] 1.1.1 创建 `src/lib/utils/permission.ts`
- [x] 1.1.2 实现 `checkTicketPermission()` 函数
- [x] 1.1.3 实现 `filterTicketsByPermission()` 函数
- [x] 1.1.4 添加权限调试日志

### 1.2 修复客户工单隔离
- [x] 1.2.1 修改 `GET /api/tickets` 使用权限过滤
- [x] 1.2.2 修改 `GET /api/tickets/[id]` 添加单工单权限检查
- [ ] 1.2.3 验证客户只能看到自己的工单

### 1.3 修复 Staff 可见性权限
- [x] 1.3.1 确保 Staff 只能看到分配给自己的工单
- [x] 1.3.2 隐藏未分配工单（仅 Admin 可见）
- [ ] 1.3.3 验证非自己负责工单不可见
- [x] 1.3.4 处理未知区域工单（未分配仅 Admin 可见；已分配仅 assignee 可见）

### 1.4 修复工单分配规则
- [x] 1.4.1 移除默认分配给 Admin 的逻辑
- [x] 1.4.2 新工单保持未分配状态
- [x] 1.4.3 根据客户区域设置 group_id
- [x] 1.4.4 无区域工单不进入自动分配，留给 Admin 处理

## 2. 功能修复（P0）

### 2.1 修复工单删除
- [ ] 2.1.1 检查 Admin 页面删除按钮的事件绑定
- [ ] 2.1.2 确保 DELETE API 正确调用
- [ ] 2.1.3 添加错误处理和用户反馈

### 2.2 实现客户关闭工单
- [x] 2.2.1 在客户工单详情页添加"关闭工单"按钮
- [x] 2.2.2 调用状态更新 API
- [x] 2.2.3 添加确认对话框
- [x] 2.2.4 添加 i18n 翻译

### 2.3 修复 Live 附件发送
- [ ] 2.3.1 检查 Live 聊天附件上传逻辑
- [ ] 2.3.2 修复上传失败问题
- [ ] 2.3.3 验证附件正确发送

## 3. 用户体验改进（P1）

### 3.1 修复消息显示逻辑
- [x] 3.1.1 分析当前消息对齐逻辑
- [x] 3.1.2 根据查看者角色调整对齐
- [x] 3.1.3 验证 Staff 和 Customer 视角

### 3.2 修改时间格式
- [x] 3.2.1 修改工单列表时间显示为 `YYYY-MM-DD HH:mm`
- [x] 3.2.2 修改工单详情页时间显示

### 3.3 修复工单数量统计
- [x] 3.3.1 检查分页统计逻辑
- [x] 3.3.2 确保数量与实际显示一致

## 4. 翻译和 UI 改进（P2）

### 4.1 翻译完善
- [x] 4.1.1 添加必填项验证提示翻译（ticket-actions.tsx 已修复）
- [x] 4.1.2 添加附件上传按钮翻译
- [x] 4.1.3 本地化发送者名称（避免显示中文"客服"）

### 4.2 UI 样式改进
- [x] 4.2.1 修改 NEW 状态标签为亮色
- [x] 4.2.2 添加工单标题 Tooltip
- [x] 4.2.3 实现输入框自适应高度

### 4.3 功能增强（可选）
- [ ] 4.3.1 支持粘贴图片功能

## 5. 测试和验证

### 5.1 权限测试
- [ ] 5.1.1 编写权限过滤单元测试
- [ ] 5.1.2 测试客户工单隔离
- [ ] 5.1.3 测试 Staff 仅自己负责工单
- [ ] 5.1.4 测试 Admin 全局权限

### 5.2 功能测试
- [ ] 5.2.1 测试工单删除功能
- [ ] 5.2.2 测试客户关闭工单
- [ ] 5.2.3 测试 Live 附件发送

### 5.3 回归测试
- [ ] 5.3.1 验证现有功能不受影响
- [ ] 5.3.2 多区域账号测试

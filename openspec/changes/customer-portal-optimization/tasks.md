# Customer Portal 优化任务清单

## 阶段1：紧急Bug修复（P0）⚠️

### 1.1 修复工单详情页路由
- [ ] 分析路由错误原因（跳转到/staff/tickets而非/my-tickets）
- [ ] 修复 `src/app/(customer)/my-tickets/page.tsx` 第173和200行
- [ ] 更新工单列表的点击处理逻辑
  ```typescript
  // 错误：router.push(`/staff/tickets/${ticket.id}`)
  // 正确：router.push(`/my-tickets/${ticket.id}`)
  ```
- [ ] 验证路由参数正确传递
- [ ] 测试不同工单ID的导航
- [ ] 添加路由守卫防止错误跳转
- **预计时间**：2-3小时
- **优先级**：P0
- **文件**：
  - `src/app/(customer)/my-tickets/page.tsx:173,200`

### 1.2 解决工单列表为空问题
- [ ] 分析工单列表显示"共 0 个工单"的原因
- [ ] 检查API端点 `/api/customer/tickets`
- [ ] 验证Zammad API集成和用户映射
  - 检查 `src/lib/zammad/user-mapping.ts`
  - 确认customer用户的Zammad ID正确
- [ ] 修复数据获取逻辑
- [ ] 添加空状态友好提示
- [ ] 测试工单列表加载
- [ ] 添加错误处理和重试机制
- **预计时间**：4-6小时
- **优先级**：P0
- **文件**：
  - `src/app/api/customer/tickets/route.ts`
  - `src/lib/zammad/user-mapping.ts`
  - `src/app/(customer)/my-tickets/page.tsx`

### 1.3 修复FAQ页面交互问题
- [ ] 验证FAQ搜索功能
- [ ] 检查FAQ文章点击和展开
- [ ] 测试分类浏览功能
- [ ] 优化加载性能
- [ ] 添加加载骨架屏
- [ ] 测试搜索和过滤功能
- **预计时间**：3-4小时
- **优先级**：P0
- **文件**：
  - `src/app/(customer)/faq/page.tsx`

### 1.4 解决SSE连接问题
- [ ] 修复SSE Heartbeat timeout错误
- [ ] 优化客户端重连逻辑
- [ ] 添加连接状态指示
- [ ] 实现离线消息队列
- [ ] 测试长时间连接稳定性
- [ ] 添加错误恢复机制
- **预计时间**：4-5小时
- **优先级**：P0
- **文件**：
  - `src/lib/sse/sse-client.ts`

---

## 阶段2：核心功能完善（P1）

### 2.1 实现文件上传功能

#### 2.1.1 后端文件上传实现
- [ ] 设计文件存储架构
  - 选择存储方案（本地/云存储）
  - 设计文件路径结构
  - 制定安全策略
- [ ] 实现文件上传API
  - `POST /api/files/upload` - 上传文件
  - 支持多文件上传
  - 文件类型验证（MIME type）
  - 文件大小限制（如5MB）
- [ ] 添加安全措施
  - 文件名清理
  - 扩展名白名单
  - 病毒扫描（可选）
- [ ] 实现文件存储
  - 生成唯一文件ID
  - 存储元数据
  - 创建缩略图（图片）
- [ ] 添加文件访问API
  - `GET /api/files/[id]` - 下载文件
  - `GET /api/files/[id]/thumbnail` - 获取缩略图
- [ ] 测试上传和下载
- **预计时间**：2-3天
- **优先级**：P1
- **文件**：
  - `src/app/api/files/upload/route.ts`
  - `src/app/api/files/[id]/route.ts`

#### 2.1.2 前端文件上传集成
- [ ] 修复工单创建页面的TODO (line 85)
- [ ] 实现文件选择组件
  - 拖放上传
  - 点击选择
  - 多文件支持
- [ ] 添加上传进度显示
- [ ] 实现文件预览
  - 图片缩略图
  - 文档图标
  - 文件大小显示
- [ ] 添加删除功能
- [ ] 集成到工单创建表单
- [ ] 集成到对话消息
- [ ] 测试完整上传流程
- **预计时间**：2-3天
- **优先级**：P1
- **文件**：
  - `src/app/(customer)/my-tickets/create/page.tsx:85`
  - `src/components/file-upload.tsx`
  - `src/app/(customer)/conversations/[id]/page.tsx`

### 2.2 完善工单管理功能

#### 2.2.1 工单创建增强
- [ ] 优化工单表单布局
- [ ] 添加优先级选择说明
- [ ] 实现自动分类建议
- [ ] 添加相似问题提示
- [ ] 实现草稿保存
- [ ] 添加表单验证
- [ ] 测试创建流程
- **预计时间**：2-3天
- **优先级**：P1
- **文件**：
  - `src/app/(customer)/my-tickets/create/page.tsx`

#### 2.2.2 工单详情增强
- [ ] 创建工单详情页面组件
- [ ] 显示工单完整信息
  - 基本信息
  - 描述内容
  - 附件列表
  - 状态历史
- [ ] 实现工单回复功能
- [ ] 添加附件下载
- [ ] 实现状态跟踪
- [ ] 添加满意度评价
- [ ] 测试详情页功能
- **预计时间**：2-3天
- **优先级**：P1
- **文件**：
  - `src/app/(customer)/my-tickets/[id]/page.tsx`

#### 2.2.3 工单列表优化
- [ ] 添加高级筛选
  - 按状态筛选
  - 按优先级筛选
  - 按日期范围筛选
- [ ] 实现排序功能
- [ ] 添加搜索功能
- [ ] 实现分页加载
- [ ] 添加工单统计
- [ ] 优化列表性能
- [ ] 测试列表功能
- **预计时间**：2天
- **优先级**：P1
- **文件**：
  - `src/app/(customer)/my-tickets/page.tsx`

### 2.3 实现FAQ评分系统

#### 2.3.1 后端评分API
- [ ] 设计评分数据模型
- [ ] 实现评分API端点
  - `POST /api/faq/[id]/rating` - 提交评分
  - `GET /api/faq/[id]/rating` - 获取评分统计
  - `DELETE /api/faq/[id]/rating` - 撤销评分
- [ ] 添加防重复评分逻辑
- [ ] 实现评分聚合计算
- [ ] 添加评分缓存
- [ ] 测试评分功能
- **预计时间**：2天
- **优先级**：P1
- **文件**：
  - `src/app/api/faq/[id]/rating/route.ts`

#### 2.3.2 前端评分界面
- [ ] 设计评分UI组件
  - 点赞/点踩按钮
  - 评分统计显示
  - 用户已评分状态
- [ ] 实现评分交互
  - 点击评分
  - 乐观更新
  - 错误回滚
- [ ] 添加评分反馈
  - 成功提示
  - 错误处理
- [ ] 集成到FAQ文章页
- [ ] 测试评分流程
- **预计时间**：1-2天
- **优先级**：P1
- **文件**：
  - `src/components/faq/faq-rating.tsx`（新建）
  - `src/app/(customer)/faq/page.tsx`

#### 2.3.3 FAQ评论系统（可选）
- [ ] 设计评论数据模型
- [ ] 实现评论API
- [ ] 创建评论组件
- [ ] 添加评论审核
- [ ] 测试评论功能
- **预计时间**：2-3天
- **优先级**：P2
- **文件**：
  - `src/app/api/faq/[id]/comments/route.ts`（新建）

### 2.4 增强对话功能

#### 2.4.1 对话历史记录
- [ ] 实现历史消息分页加载
- [ ] 添加滚动到底部按钮
- [ ] 实现消息搜索
- [ ] 添加消息书签
- [ ] 优化历史加载性能
- [ ] 测试历史功能
- **预计时间**：2-3天
- **优先级**：P1
- **文件**：
  - `src/app/(customer)/conversations/[id]/page.tsx`

#### 2.4.2 对话导出功能
- [ ] 设计导出格式（PDF/TXT）
- [ ] 实现导出API
  - `GET /api/conversations/[id]/export` - 导出对话
- [ ] 创建导出按钮
- [ ] 添加导出进度提示
- [ ] 测试导出功能
- **预计时间**：2天
- **优先级**：P1
- **文件**：
  - `src/app/api/conversations/[id]/export/route.ts`（新建）

#### 2.4.3 对话列表管理
- [ ] 创建对话列表页面
- [ ] 显示所有对话
- [ ] 实现对话搜索
- [ ] 添加对话归档
- [ ] 实现对话删除
- [ ] 测试列表功能
- **预计时间**：2-3天
- **优先级**：P1
- **文件**：
  - `src/app/(customer)/conversations/page.tsx`

---

## 阶段3：用户体验增强（P2）

### 3.1 优化Dashboard个性化

#### 3.1.1 个性化内容
- [ ] 设计个性化算法
- [ ] 实现推荐API
  - 推荐FAQ文章
  - 推荐相关工单
- [ ] 创建个性化组件
- [ ] 添加快捷操作
- [ ] 实现数据可视化
- [ ] 测试个性化效果
- **预计时间**：3-4天
- **优先级**：P2
- **文件**：
  - `src/app/(customer)/dashboard/page.tsx`

#### 3.1.2 自定义面板
- [ ] 实现面板拖拽排序
- [ ] 添加面板显示/隐藏
- [ ] 保存用户偏好
- [ ] 实现布局预设
- [ ] 测试自定义功能
- **预计时间**：2-3天
- **优先级**：P2

### 3.2 通知中心和消息提醒

#### 3.2.1 通知中心
- [ ] 设计通知数据模型
- [ ] 实现通知API
  - `GET /api/customer/notifications` - 获取通知
  - `PUT /api/customer/notifications/[id]/read` - 标记已读
  - `DELETE /api/customer/notifications/[id]` - 删除通知
- [ ] 创建通知中心组件
  - 通知列表
  - 未读标记
  - 批量操作
- [ ] 实现通知分类
  - 工单更新
  - 对话消息
  - 系统公告
- [ ] 添加通知铃铛图标
- [ ] 实现实时推送
- [ ] 测试通知功能
- **预计时间**：3-4天
- **优先级**：P2
- **文件**：
  - `src/app/api/customer/notifications/route.ts`（新建）
  - `src/components/customer/notification-center.tsx`（新建）

#### 3.2.2 通知设置
- [ ] 创建通知偏好设置页面
- [ ] 实现通知开关
  - 邮件通知
  - 短信通知
  - 浏览器推送
- [ ] 添加通知频率设置
- [ ] 实现免打扰模式
- [ ] 保存用户偏好
- [ ] 测试设置功能
- **预计时间**：2天
- **优先级**：P2
- **文件**：
  - `src/app/(customer)/settings/page.tsx`

#### 3.2.3 浏览器推送通知
- [ ] 实现Push API集成
- [ ] 请求通知权限
- [ ] 实现Service Worker
- [ ] 创建推送消息
- [ ] 添加点击处理
- [ ] 测试推送功能
- **预计时间**：2-3天
- **优先级**：P2
- **文件**：
  - `public/service-worker.js`（新建）

### 3.3 帮助引导和新手向导

#### 3.3.1 新手向导
- [ ] 设计向导流程
- [ ] 创建向导组件
  - 欢迎页面
  - 功能介绍
  - 交互演示
- [ ] 实现步骤导航
- [ ] 添加跳过选项
- [ ] 保存完成状态
- [ ] 测试向导流程
- **预计时间**：2-3天
- **优先级**：P2
- **文件**：
  - `src/components/customer/onboarding-tour.tsx`（新建）

#### 3.3.2 上下文帮助
- [ ] 添加帮助图标
- [ ] 实现帮助气泡
- [ ] 创建帮助文档链接
- [ ] 添加视频教程
- [ ] 实现智能提示
- [ ] 测试帮助功能
- **预计时间**：2天
- **优先级**：P2

### 3.4 服务预约和排队

#### 3.4.1 预约系统
- [ ] 设计预约数据模型
- [ ] 实现预约API
  - `GET /api/appointments/slots` - 获取可用时段
  - `POST /api/appointments` - 创建预约
  - `DELETE /api/appointments/[id]` - 取消预约
- [ ] 创建预约日历组件
- [ ] 实现时段选择
- [ ] 添加预约提醒
- [ ] 测试预约功能
- **预计时间**：3-4天
- **优先级**：P2
- **文件**：
  - `src/app/api/appointments/route.ts`（新建）
  - `src/app/(customer)/appointments/page.tsx`（新建）

#### 3.4.2 虚拟排队
- [ ] 设计排队逻辑
- [ ] 实现排队API
- [ ] 创建排队界面
  - 当前位置显示
  - 预计等待时间
  - 排队人数
- [ ] 实现实时更新
- [ ] 添加离队选项
- [ ] 测试排队功能
- **预计时间**：2-3天
- **优先级**：P2

### 3.5 多渠道通知支持

#### 3.5.1 邮件通知
- [ ] 集成邮件服务（SendGrid/Mailgun）
- [ ] 设计邮件模板
- [ ] 实现邮件发送API
- [ ] 添加邮件队列
- [ ] 实现邮件追踪
- [ ] 测试邮件发送
- **预计时间**：2-3天
- **优先级**：P2
- **文件**：
  - `src/lib/email/email-service.ts`（新建）

#### 3.5.2 短信通知
- [ ] 集成短信服务（Twilio）
- [ ] 设计短信模板
- [ ] 实现短信发送API
- [ ] 添加短信限流
- [ ] 实现发送状态跟踪
- [ ] 测试短信功能
- **预计时间**：2-3天
- **优先级**：P2
- **文件**：
  - `src/lib/sms/sms-service.ts`（新建）

---

## 阶段4：自助服务增强（P3）

### 4.1 智能FAQ推荐

#### 4.1.1 推荐算法
- [ ] 设计推荐算法
  - 基于内容的推荐
  - 协同过滤
  - 混合推荐
- [ ] 实现相似度计算
- [ ] 创建推荐API
- [ ] 添加推荐缓存
- [ ] 测试推荐准确性
- **预计时间**：4-5天
- **优先级**：P3

#### 4.1.2 智能搜索
- [ ] 实现全文搜索
- [ ] 添加搜索建议
- [ ] 实现拼写纠正
- [ ] 添加搜索历史
- [ ] 优化搜索性能
- [ ] 测试搜索功能
- **预计时间**：3-4天
- **优先级**：P3

### 4.2 问题诊断向导

#### 4.2.1 诊断流程
- [ ] 设计诊断决策树
- [ ] 实现诊断引擎
- [ ] 创建诊断界面
  - 问题选择
  - 步骤导航
  - 解决方案展示
- [ ] 添加诊断历史
- [ ] 实现结果导出
- [ ] 测试诊断流程
- **预计时间**：4-5天
- **优先级**：P3
- **文件**：
  - `src/app/(customer)/diagnostic/page.tsx`（新建）

### 4.3 客户社区功能

#### 4.3.1 社区论坛
- [ ] 设计论坛数据模型
- [ ] 实现论坛API
- [ ] 创建论坛界面
  - 帖子列表
  - 帖子详情
  - 回复功能
- [ ] 添加内容审核
- [ ] 实现积分系统
- [ ] 测试社区功能
- **预计时间**：5-7天
- **优先级**：P3
- **文件**：
  - `src/app/(customer)/community/page.tsx`（新建）

### 4.4 自助问题解决流程

#### 4.4.1 解决方案库
- [ ] 创建解决方案数据库
- [ ] 实现方案搜索
- [ ] 添加方案投票
- [ ] 实现方案评论
- [ ] 添加方案分享
- [ ] 测试方案功能
- **预计时间**：3-4天
- **优先级**：P3

### 4.5 客户满意度调查

#### 4.5.1 调查系统
- [ ] 设计调查表单
- [ ] 实现调查API
- [ ] 创建调查组件
  - NPS评分
  - 多选题
  - 开放式反馈
- [ ] 添加调查触发逻辑
- [ ] 实现数据分析
- [ ] 测试调查功能
- **预计时间**：3-4天
- **优先级**：P3
- **文件**：
  - `src/app/api/surveys/route.ts`（新建）
  - `src/components/customer/satisfaction-survey.tsx`（新建）

---

## 测试与质量保证

### 单元测试
- [ ] 工单路由测试
- [ ] 文件上传测试
- [ ] FAQ评分测试
- [ ] 通知系统测试
- [ ] API端点测试

### 集成测试
- [ ] 工单创建流程测试
- [ ] 对话完整流程测试
- [ ] 文件上传下载测试
- [ ] 通知推送测试

### E2E测试
- [ ] Playwright 用户旅程测试
- [ ] 跨浏览器兼容性测试
- [ ] 移动端响应式测试
- [ ] 性能基准测试

### 用户验收测试
- [ ] 客户用户测试
- [ ] 可用性测试
- [ ] 功能验收
- [ ] 性能验收

---

## 里程碑

| 里程碑 | 完成标准 | 预计日期 |
|--------|---------|---------|
| M1: 紧急修复完成 | 所有P0 Bug修复，核心功能可用 | 第1周 |
| M2: 核心功能上线 | 文件上传、工单管理、FAQ评分完成 | 第3周 |
| M3: 体验优化完成 | 通知中心、帮助引导、预约系统完成 | 第6周 |
| M4: 自助服务上线 | 智能推荐、诊断向导、社区功能完成 | 第9周 |

---

## 成功指标

### 功能指标
- [ ] 工单路由错误率 < 0.1%
- [ ] 文件上传成功率 > 99%
- [ ] FAQ评分参与率 > 30%
- [ ] 对话导出成功率 > 98%

### 用户体验指标
- [ ] 页面加载时间 < 2秒
- [ ] 首屏渲染时间 < 1秒
- [ ] 移动端适配完成度 100%
- [ ] 无障碍访问WCAG 2.1 AA级

### 业务指标
- [ ] 自助解决率提升 > 40%
- [ ] 人工客服咨询减少 > 30%
- [ ] 客户满意度 > 4.5/5.0
- [ ] FAQ使用率提升 > 50%
- [ ] 工单创建效率提升 > 35%

---

## 依赖关系

### 与Staff Portal的协同
- **文件上传系统** - 需要与Staff Portal共用
- **实时通知系统** - 需要与Staff Portal SSE基础设施协同
- **工单系统** - 需要确保两端数据一致性

### 技术依赖
- **数据库** - 需要与Staff Portal优化协调数据库变更
- **API版本** - 需要保持API兼容性
- **认证系统** - 需要统一认证策略

### 建议实施顺序
1. 先完成Staff Portal的P0紧急修复
2. 并行进行两个Portal的文件上传功能
3. 协同完成实时通知系统
4. 独立完成各自的用户体验增强
